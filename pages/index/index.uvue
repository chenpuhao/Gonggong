<template>
  <view class="container">
    <view class="service-cards">
      <view class="service-card" @click="navigateTo('/pages/classroom/index')">
        <image class="service-icon" src="/static/images/classroom.png"></image>
        <text class="service-name">ç©ºæ•™å®¤</text>
      </view>
      <view class="service-card" @click="navigateTo('/pages/grades/index')">
        <image class="service-icon" src="/static/images/trophy.png"></image>
        <text class="service-name">æŸ¥æˆç»©</text>
      </view>
      <view class="service-card" @click="navigateTo('/pages/schedule/index')">
        <image class="service-icon" src="/static/images/calendar.png"></image>
        <text class="service-name">è¯¾ç¨‹è¡¨</text>
      </view>
    </view>

    <!-- å°†æ ‡ç­¾å¯¼èˆªç‹¬ç«‹äºå¡ç‰‡å®¹å™¨ -->
    <view class="tabs-wrapper">
      <view class="tab-header">
        <view class="tab-item" :class="{ active: currentTab === 'schedule' }" @click="switchTab('schedule')">
          <text class="tab-text">è¯¾ç¨‹è¡¨</text>
          <view class="tab-indicator"></view>
        </view>
        <view class="tab-divider"></view>
        <view class="tab-item" :class="{ active: currentTab === 'countdown' }" @click="switchTab('countdown')">
          <text class="tab-text">å€’è®¡æ—¶</text>
          <view class="tab-indicator"></view>
        </view>
      </view>
    </view>

    <!-- è¯¾ç¨‹è¡¨å†…å®¹ -->
    <view class="tab-container" v-if="currentTab === 'schedule'">
      <view class="schedule-content">
        <view class="schedule-header">
          <view class="date-circle">
            <text class="date-number">{{todayLessons}}</text>
          </view>
          <view class="date-info">
            <text class="date-day">TUE.</text>
            <text class="date-lessons">ä»Šæ—¥å…±{{todayLessons}}èŠ‚è¯¾</text>
          </view>
          <view class="semester-info">
            <text class="date-full">{{currentDate}}</text>
            <text class="week-info">ç¬¬{{currentWeek}}å‘¨</text>
          </view>
        </view>

        <view class="schedule-body" v-if="todayLessons > 0">
          <!-- è¯¾ç¨‹åˆ—è¡¨ -->
        </view>
        <view class="empty-schedule" v-else>
          <view class="piggy-svg">
            <image src="/static/images/noCourse.png"></image>
          </view>
          <text class="empty-text">ä»Šå¤©æ²¡æœ‰è¯¾å“Ÿ~</text>
        </view>
      </view>
    </view>

    <!-- å€’è®¡æ—¶å†…å®¹åŒºåŸŸ -->
    <view class="tab-container" v-if="currentTab === 'countdown'">
      <!-- å›ºå®šéƒ¨åˆ†ï¼šæ·»åŠ å€’è®¡æ—¶æŒ‰é’®å’Œç­›é€‰ -->
      <view class="countdown-header">
        <view class="add-btn" @click="addCountdown">
          <text class="add-icon">+</text>
          <text class="add-text">æ·»åŠ å€’è®¡æ—¶</text>
        </view>
        <view class="filter">
          <view class="filter-item" @click="toggleFilter">
            <view class="circle" :class="{ checked: onlyExams }"></view>
            <text class="filter-text">ä»…è€ƒè¯•</text>
          </view>
        </view>
      </view>

      <!-- åˆ†å‰²çº¿ -->
      <view class="divider"></view>

      <!-- å€’è®¡æ—¶åˆ—è¡¨éƒ¨åˆ† -->
      <scroll-view class="countdown-scroll" scroll-y="true" @scroll="resetOthers">
        <view class="countdown-list">
          <view v-for="(exam, index) in examList" :key="index" class="countdown-wrapper">
            <view class="countdown-content" :style="{ transform: `translateX(${examSwipeState[index] || 0}px)` }">
              <view class="countdown-item" @touchstart="touchStart($event, index)" @touchend="touchEnd($event, index)">
                <!-- è€ƒè¯•å†…å®¹ -->
                <view class="exam-info">
                  <view class="exam-title-row">
                    <text class="exam-title">{{exam.title}}</text>
                    <view class="exam-tag"><text>{{exam.type}}</text></view>
                  </view>
                  <view class="exam-time">
                    <text class="time-icon">ğŸ•’</text>
                    <text class="time-text">{{exam.date}} {{exam.weekday}}</text>
                    <text class="location-icon" style="margin-left: 15rpx">ğŸ“</text>
                    <text class="location-text">{{exam.location}}</text>
                  </view>
                </view>
                <view class="countdown-days">
                  <text class="days-text">è¿˜å‰©</text>
                  <text class="days-number">{{exam.daysLeft}}</text>
                  <text class="days-unit">å¤©</text>
                </view>
              </view>
              <view class="action-buttons">
                <view class="pin-btn" @click="pinItem(index)">
                  <view class="btn-inner">
                    <text class="pin-icon">ğŸ“Œ</text>
                    <text class="btn-text">ç½®é¡¶</text>
                  </view>
                </view>
                <view class="delete-btn" @click="deleteItem(index)">
                  <view class="btn-inner">
                    <text class="delete-icon">ğŸ—‘ï¸</text>
                    <text class="btn-text">åˆ é™¤</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>


    <view class="tab-bar">
      <view class="tab-bar-item active">
        <image class="tab-bar-icon" src="/static/images/home-active.png"></image>
        <text class="tab-bar-text">é¦–é¡µ</text>
      </view>
      <view class="tab-bar-item" @click="switchPage('info')">
        <image class="tab-bar-icon" src="/static/images/user.png"></image>
        <text class="tab-bar-text">æˆ‘çš„</text>
      </view>
    </view>
  </view>
</template>

<script>
import info from "@/pages/index/info.uvue";

export default {
  computed: {
    info() {
      return info
    }
  },
  data() {
    return {
      currentTab: 'countdown',
      todayLessons: 0,
      currentDate: '2025/05/13',
      currentWeek: '13',
      currentPage: 'index',
      onlyExams: true,
      // æ·»åŠ å·¦æ»‘ç›¸å…³çš„å˜é‡
      swipeDistance: 0,
      isVisible: false,
      examList: [
        {
          title: 'æ•°æ®ç»“æ„',
          type: 'è€ƒè¯•',
          date: '2025/06/09 19:30-21:30',
          weekday: 'æ˜ŸæœŸä¸€',
          location: 'è®¡ç®—ä¸­å¿ƒB307',
          daysLeft: 24
        },
        {
          title: 'ç¦»æ•£æ•°å­¦',
          type: 'è€ƒè¯•',
          date: '2025/06/12 10:30-12:30',
          weekday: 'æ˜ŸæœŸå››',
          location: 'å°šç¾æ¥¼äºŒé˜¶æ¢¯',
          daysLeft: 27
        },
        {
          title: 'è®¡ç®—æœºç»„æˆä¸ä½“ç³»ç»“æ„',
          type: 'è€ƒè¯•',
          date: '2025/06/16 10:30-12:30',
          weekday: 'æ˜ŸæœŸä¸€',
          location: 'åŒ—å±±äºŒé˜¶æ¢¯',
          daysLeft: 31
        },
        {
          title: 'å¤§å­¦å¤–è¯­2',
          type: 'è€ƒè¯•',
          date: '2025/06/19 14:00-16:00',
          weekday: 'æ˜ŸæœŸå››',
          location: 'é€¸å¤«æ¥¼äºŒé˜¶',
          daysLeft: 34
        },
        {
          title: 'å›½å®¶å®‰å…¨æ•™è‚²',
          type: 'è€ƒè¯•',
          date: '2025/06/19 16:30-18:30',
          weekday: 'æ˜ŸæœŸå››',
          location: 'é€¸å¤«æ¥¼ä¸€é˜¶',
          daysLeft: 34
        }
      ],
      examSwipeState: {},
      startX: 0,
      currentIndex: null,
      isSwiping: false
    }
  },
  onLoad() {
    this.getCurrentDate();
    this.getExamData();
  },
  methods: {
    // è·å–è€ƒè¯•æ•°æ®
    async getExamData() {
      try {
        // è¿™é‡Œå°†æ¥ä¼šè°ƒç”¨å®é™…çš„API
        // const response = await uni.request({ url: 'your-exam-api-endpoint' });
        // this.examList = response.data;

        // ç°åœ¨ä½¿ç”¨é¢„è®¾çš„æ¨¡æ‹Ÿæ•°æ®
      } catch (error) {
        uni.showToast({
          title: 'è·å–è€ƒè¯•æ•°æ®å¤±è´¥',
          icon: 'none'
        });
      }
    },

    // é‡ç½®å…¶ä»–æ¡ç›®
    resetOthers(e) {
      // æ»šåŠ¨æ—¶é‡ç½®æ‰€æœ‰æ»‘åŠ¨çŠ¶æ€
      if (!this.isSwiping && Object.keys(this.examSwipeState).length > 0) {
        this.examSwipeState = {};
      }
    },

    // æ»‘åŠ¨å˜åŒ–äº‹ä»¶å¤„ç†
    touchStart(e, index) {
      this.startX = e.changedTouches[0].clientX;
      this.currentIndex = index;
      this.isSwiping = true;

      // å¦‚æœç‚¹å‡»äº†ä¸€ä¸ªæ–°çš„æ¡ç›®ï¼Œå…ˆé‡ç½®å…¶ä»–æ‰€æœ‰æ¡ç›®
      Object.keys(this.examSwipeState).forEach(key => {
        if (Number(key) !== index && this.examSwipeState[key] !== 0) {
          this.$set(this.examSwipeState, key, 0);
        }
      });
    },

    // è§¦æ‘¸ç»“æŸäº‹ä»¶
    touchEnd(e, index) {
      const endX = e.changedTouches[0].clientX;
      const distance = endX - this.startX;

      // å·¦æ»‘æ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼Œä»…æ˜¾ç¤ºåˆšå¥½èƒ½å±•ç¤ºä¸¤ä¸ªæŒ‰é’®çš„å®½åº¦
      if (distance < -50) {
        // æ¯ä¸ªæŒ‰é’®å®½åº¦ä¸º120rpxï¼Œå…±240rpxï¼Œè½¬æ¢ä¸ºpxå¤§çº¦ä¸º120px
        this.$set(this.examSwipeState, index, -120);
      }
      // å³æ»‘éšè—æ“ä½œæŒ‰é’®
      else if (distance > 50 || (distance > -50 && distance < 50 && this.examSwipeState[index] === -120)) {
        this.$set(this.examSwipeState, index, 0);
      }

      this.isSwiping = false;
    },

    // ç½®é¡¶é¡¹ç›®
    pinItem(index) {
      const item = this.examList[index];
      // ç§»é™¤å½“å‰é¡¹
      this.examList.splice(index, 1);
      // æ·»åŠ åˆ°é¡¶éƒ¨
      this.examList.unshift(item);
      // é‡ç½®æ»‘åŠ¨çŠ¶æ€
      this.examSwipeState = {};

      uni.showToast({
        title: 'å·²ç½®é¡¶',
        icon: 'none'
      });
    },

    // åˆ é™¤é¡¹ç›®
    deleteItem(index) {
      const item = this.examList[index];
      if (item.type === 'è€ƒè¯•') {
        uni.showToast({
          title: 'è€ƒè¯•é¡¹ç›®ä¸å¯åˆ é™¤',
          icon: 'none'
        });
        // é‡ç½®è¯¥é¡¹çš„æ»‘åŠ¨çŠ¶æ€
        this.$set(this.examSwipeState, index, 0);
        return;
      }

      uni.showModal({
        title: 'ç¡®è®¤åˆ é™¤',
        content: `ç¡®å®šè¦åˆ é™¤"${item.title}"å—ï¼Ÿ`,
        success: (res) => {
          if (res.confirm) {
            this.examList.splice(index, 1);
            // æ›´æ–°æ»‘åŠ¨çŠ¶æ€ï¼Œç§»é™¤å·²åˆ é™¤é¡¹çš„çŠ¶æ€
            const newState = {};
            Object.keys(this.examSwipeState).forEach(key => {
              if (Number(key) < index) {
                newState[key] = this.examSwipeState[key];
              } else if (Number(key) > index) {
                newState[Number(key) - 1] = this.examSwipeState[key];
              }
            });
            this.examSwipeState = newState;

            uni.showToast({
              title: 'å·²åˆ é™¤',
              icon: 'none'
            });
          } else {
            // å–æ¶ˆæ—¶é‡ç½®æ»‘åŠ¨çŠ¶æ€
            this.$set(this.examSwipeState, index, 0);
          }
        }
      });
    },

    // åˆ‡æ¢æ ‡ç­¾é¡µæ—¶é‡ç½®æ‰€æœ‰æ»‘åŠ¨çŠ¶æ€
    switchTab(tab) {
      this.currentTab = tab;
      // é‡ç½®æ‰€æœ‰æ»‘åŠ¨çŠ¶æ€
      this.examSwipeState = {};
    },

    // æ·»åŠ å€’è®¡æ—¶
    addCountdown() {
      uni.showToast({
        title: 'æ·»åŠ å€’è®¡æ—¶åŠŸèƒ½å¾…å®ç°',
        icon: 'none'
      });
    },

    // åˆ‡æ¢ç­›é€‰å™¨
    toggleFilter() {
      this.onlyExams = !this.onlyExams;
      // è¿™é‡Œå¯ä»¥æ·»åŠ ç­›é€‰é€»è¾‘
    },

    switchPage(page) {
      if (page === this.currentPage) return;

      if (page === 'index') {
        // å¦‚æœå·²ç»åœ¨é¦–é¡µï¼Œåªéœ€æ›´æ–°çŠ¶æ€
        if (getCurrentPages().pop().route === 'pages/index/index') {
          this.currentPage = 'index';
        } else {
          uni.redirectTo({
            url: '/pages/index/index',
            fail: (err) => {
              console.error('é¡µé¢è·³è½¬å¤±è´¥', err);
              uni.showToast({
                title: 'é¡µé¢è·³è½¬å¤±è´¥',
                icon: 'none'
              });
            }
          });
        }
      } else if (page === 'info') {
        // è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µ
        uni.navigateTo({
          url: '/pages/index/info',
          success: () => {
            this.currentPage = 'info';
          },
          fail: (err) => {
            console.error('é¡µé¢è·³è½¬å¤±è´¥', err);
            uni.showToast({
              title: 'é¡µé¢è·³è½¬å¤±è´¥',
              icon: 'none'
            });
          }
        });
      }
    },

    // è·³è½¬åˆ°å¯¹åº”çš„é¡µé¢
    navigateTo(url) {
      uni.navigateTo({
        url: url,
        fail: (err) => {
          console.error('é¡µé¢è·³è½¬å¤±è´¥', err);
          uni.showToast({
            title: 'é¡µé¢è·³è½¬å¤±è´¥',
            icon: 'none'
          });
        }
      });
    },


    // è·å–å½“å‰æ—¥æœŸ
    getCurrentDate() {
      const date = new Date();
      const year = date.getFullYear();
      const month = ('0' + (date.getMonth() + 1)).slice(-2);
      const day = ('0' + date.getDate()).slice(-2);
      this.currentDate = `${year}/${month}/${day}`;
    }
  }
}
</script>

<style>
.container {
  flex-direction: column;
  width: 750rpx;
  background-color: #f5f5f5;
  min-height: 100vh;
}

/* é¡¶éƒ¨æœåŠ¡å¡ç‰‡åŒºåŸŸ */
.service-cards {
  width: 750rpx;
  height: 330rpx;
  flex-direction: row;
  justify-content: space-around;
  align-items: center;
  background-color: #f66b6b;
  border-radius: 0 0 30rpx 30rpx;
  padding: 60rpx 20rpx 20rpx;
  box-shadow: 0 4rpx 10rpx rgba(0, 0, 0, 0.1);
}

.service-card {
  align-items: center;
  justify-content: center;
  width: 200rpx;
  height: 160rpx;
  margin-top: 50rpx;
}

.service-icon {
  width: 80rpx;
  height: 80rpx;
  margin-bottom: 16rpx;
}

.service-name {
  font-size: 28rpx;
  color: #ffffff;
}

/* æ ‡ç­¾å¯¼èˆª */
.tabs-wrapper {
  width: 750rpx;
  margin-top: 30rpx;
  border-bottom: 1rpx solid #f0f0f0;
  background-color: transparent;
}

.tab-header {
  flex-direction: row;
  justify-content: center;
  padding: 20rpx 0;
  position: relative;
  background-color: transparent;
}

.tab-divider {
  position: absolute;
  width: 1rpx;
  height: 30rpx;
  background-color: #f0f0f0;
  top: 50%;
  left: 50%;
  transform: translateY(-50%);
}

.tab-item {
  padding: 0 70rpx;
  align-items: center;
  position: relative;
}

.tab-text {
  font-size: 32rpx;
  color: #666666;
}

.tab-indicator {
  position: absolute;
  bottom: -1rpx;
  height: 6rpx;
  width: 80rpx;
  background-color: #f66b6b;
  border-radius: 3rpx;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
}

.tab-item.active .tab-text {
  color: #f66b6b;
  font-weight: bold;
}

.tab-item.active .tab-indicator {
  opacity: 1;
}

/* å†…å®¹å¡ç‰‡ */
.tab-container {
  background-color: #ffffff;
  border-radius: 20rpx;
  width: 710rpx;
  margin: 20rpx 20rpx 120rpx 20rpx;
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* è¯¾ç¨‹è¡¨æ ·å¼ */
.schedule-content {
  padding: 10rpx 0 40rpx 0;
}

.schedule-header {
  flex-direction: row;
  padding: 30rpx;
  align-items: center;
}

.date-circle {
  width: 80rpx;
  height: 80rpx;
  background-color: #f5f5f5;
  border-radius: 40rpx;
  justify-content: center;
  align-items: center;
}

.date-number {
  font-size: 40rpx;
  font-weight: bold;
}

.date-info {
  flex: 1;
  margin-left: 30rpx;
  flex-direction: column;
  justify-content: center;
}

.date-day {
  font-size: 42rpx;
  font-weight: bold;
  color: #ff8a8a;
}

.date-lessons {
  font-size: 28rpx;
  color: #999999;
  margin-top: 5rpx;
}

.semester-info {
  flex-direction: column;
  align-items: flex-end;
}

.date-full {
  font-size: 26rpx;
  color: #333333;
}

.week-info {
  font-size: 24rpx;
  color: #666666;
  margin-top: 5rpx;
}

.empty-schedule {
  align-items: center;
  justify-content: center;
  padding: 50rpx 0;
}

.piggy-svg {
  align-items: center;
  justify-content: center;
  margin: 30rpx 0;
}

.piggy-svg image {
  width: 382rpx;
  height: 256rpx;
  margin-bottom: 30rpx;
}

.empty-text {
  font-size: 30rpx;
  color: #999999;
  margin-bottom: 20rpx;
}

/* å€’è®¡æ—¶å¤´éƒ¨ - å›ºå®šéƒ¨åˆ† */
.countdown-header {
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx 30rpx;
}

.add-btn {
  flex-direction: row;
  align-items: center;
  background-color: #f66b6b;
  border-radius: 30rpx;
  padding: 10rpx 30rpx;
}

.add-icon {
  font-size: 36rpx;
  color: #ffffff;
  margin-right: 8rpx;
}

.add-text {
  font-size: 28rpx;
  color: #ffffff;
}

.filter {
  flex-direction: row;
  align-items: center;
}

.filter-item {
  flex-direction: row;
  align-items: center;
}

.circle {
  width: 36rpx;
  height: 36rpx;
  border-radius: 18rpx;
  border: 2rpx solid #cccccc;
  margin-right: 10rpx;
}

.circle.checked {
  border-color: #f66b6b;
  background-color: #f66b6b;
}

.filter-text {
  font-size: 28rpx;
  color: #666666;
}

/* åˆ†å‰²çº¿ */
.divider {
  height: 1rpx;
  background-color: #f0f0f0;
  width: 100%;
  margin: 10rpx 0;
}

/* å¯æ»šåŠ¨åŒºåŸŸ */
.countdown-scroll {
  flex: 1;
  height: 740rpx; /* è®¾ç½®é€‚å½“é«˜åº¦ï¼Œä½¿åˆ—è¡¨å¯æ»šåŠ¨ */
}

/* å€’è®¡æ—¶åˆ—è¡¨ */
.countdown-list {
  padding: 10rpx 30rpx;
}

.countdown-item {
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  padding: 30rpx;
  background-color: #ffffff;
  width: 650rpx;
  border-bottom: 1rpx solid #f0f0f0;
}

.countdown-item:last-child {
  border-bottom: none;
}

.exam-info {
  flex: 1;
  flex-direction: column;
}

.exam-title-row {
  flex-direction: row;
  align-items: center;
  margin-bottom: 10rpx;
}

.exam-title {
  font-size: 34rpx;
  font-weight: bold;
  color: #333;
  margin-right: 15rpx;
}

.exam-tag {
  background-color: #ffc187;
  border-radius: 8rpx;
  padding: 4rpx 12rpx;
}

.exam-tag text {
  font-size: 22rpx;
  color: #ffffff;
}

.exam-time {
  flex-direction: row;
  align-items: center;
}

.time-icon, .location-icon {
  font-size: 24rpx;
  color: #999;
  margin-right: 5rpx;
}

.time-text, .location-text {
  font-size: 24rpx;
  color: #999;
}

.countdown-days {
  flex-direction: row;
  align-items: baseline;
}

.days-text {
  font-size: 26rpx;
  color: #999;
  margin-right: 5rpx;
}

.days-number {
  font-size: 48rpx;
  font-weight: bold;
  color: #f66b6b;
}

.days-unit {
  font-size: 26rpx;
  color: #999;
}

/* åº•éƒ¨å¯¼èˆªæ  */
.tab-bar {
  width: 750rpx;
  height: 100rpx;
  background-color: #ffffff;
  flex-direction: row;
  justify-content: space-around;
  align-items: center;
  position: fixed;
  bottom: 0;
  left: 0;
  border-top: 1rpx solid #f0f0f0;
}

.tab-bar-item {
  flex: 1;
  align-items: center;
  justify-content: center;
  position: relative;
}

.tab-bar-icon {
  width: 50rpx;
  height: 50rpx;
  margin-bottom: 5rpx;
}

.tab-bar-text {
  font-size: 24rpx;
  color: #999999;
}

.tab-bar-item.active .tab-bar-text {
  color: #f66b6b;
  font-weight: bold;
}

.tab-bar-item.active::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 70rpx;
  height: 4rpx;
  background-color: #f66b6b;
  border-radius: 2rpx;
}

.countdown-wrapper {
  width: 100%;
  overflow: hidden;
  margin-bottom: 2rpx;
}

.countdown-content {
  width: 830rpx;
  flex-direction: row;
  position: relative;
  transition: transform 0.2s ease;
}

.movable-area {
  width: 890rpx;
  height: 160rpx;
  position: relative;
}

.movable-view {
  width: 650rpx;
  height: 100%;
  z-index: 2;
}

.action-buttons {
  flex-direction: row;
  height: 100%;
  width: 240rpx;
}

.pin-btn, .delete-btn {
  width: 120rpx;
  height: 100%;
  align-items: center;
  justify-content: center;
}

.pin-btn {
  background-color: #81c8ff;
}

.delete-btn {
  background-color: #ff8a8a;
}

.btn-inner {
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.pin-icon, .delete-icon {
  font-size: 36rpx;
  color: #ffffff;
  margin-bottom: 8rpx;
}

.btn-text {
  font-size: 24rpx;
  color: #ffffff;
}

</style>